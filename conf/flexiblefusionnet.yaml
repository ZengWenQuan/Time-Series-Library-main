# FlexibleFusionNet 配置文件

# --- 新增：定义可复用的锚点 ---
anchor_vars:
  branch_out_channels: &branch_c 16
  branch_in_len: &branch_l 4800
  # 定义一个统一的目标输出长度
  target_len: &target_l 128
  fusion_channels: &fusion_c 32
  fusion_len: &fusion_l 128

# --- 新增：全局模型设置 ---
global_settings:
  use_batch_norm: &use_bn True
  dropout_rate: &dropout_p 0.1

# 1. 训练设置 (遵循项目现有格式)
training_settings:
  targets: ['Teff', 'logg', 'FeH', 'CFe']
  loss_function: 'mse'
  loss_weights: [1.0, 1.0, 1.0, 1.0]
  lradj: 'cos'
  mixed_precision: True

# --- 分支与头模块选择 ---
continuum_branch_name: 'CustomMoEBranch'
normalized_branch_name: 'MultiScalePyramidBranch'
fusion_name: 'FusionModule'
head_name: 'MultiTaskHead'

# 2. 连续谱分支配置 (CustomMoEBranch)
continuum_branch_config:
  fft:
    n_fft: 128
    hop_length: 16
  moe:
    num_experts: 4
    k: 2
    gating_hidden_dims: [1024, 256 , 64] # 使用列表定义更深的门控网络
  input_len: *branch_l
  expert_config:
    in_channels: 1
    input_len: *branch_l
    
    pyramid_layers:
      - {out_channels: 16, kernel_sizes: [3, 5], pool_size: 2}
      - {out_channels: 32, kernel_sizes: [3, 5], pool_size: 2}
      - {out_channels: *branch_c, kernel_sizes: [3, 5], pool_size: 2}

# 3. 归一化谱分支配置 (MultiScalePyramidBranch)
normalized_branch_config:
  in_channels: 1
  input_len: *branch_l
  
  pyramid_layers:
    - {out_channels: 128, kernel_sizes: [3, 5, 7], pool_size: 2}
    - {out_channels: 64, kernel_sizes: [3, 5, 7], pool_size: 2}
    - {out_channels: 32, kernel_sizes: [3, 5, 7], pool_size: 2}
    - {out_channels: *branch_c, kernel_sizes: [3, 5, 7], pool_size: 2}

# 4. 融合模块配置
fusion_config:
  strategy: 'cross-attention'
  # 新增：定义融合前的目标形状
  target_shape:
    channels: *fusion_c
    length: *fusion_l

# 5. 预测头配置 (MultiTaskHead)
head_config:
  in_channels: *fusion_c
  in_len: *fusion_l
  self_attention:
    heads: 32
  conv_pyramid:
    layers:
      - {out_channels: 32, kernel_size: 3, pool_size: 2}
      - {out_channels: 16, kernel_size: 3, pool_size: 2}
  ffn_layers: [512,128, 32]
  dropout: *dropout_p